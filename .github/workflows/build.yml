name: Build OnePlus SM6375 Kernel
permissions:
  contents: write
  actions: write

on:
  workflow_call:
    inputs:
      model: {required: true, type: string}
      soc: {required: true, type: string}
      kernel_source_branch: {required: true, type: string}
      android_version_name: {required: true, type: string}
      kernel_version_string: {required: true, type: string} # e.g., "5.4", "5.10"
  workflow_dispatch:
    inputs:
      model:
        description: 'Device model codename (e.g., larry)'
        required: true
        type: string
        default: 'larry'
      soc:
        description: 'SoC codename (e.g., sm6375)'
        required: true
        type: string
        default: 'sm6375'
      kernel_source_branch:
        description: 'Kernel source branch for Teamhackneyed/android_kernel_oneplus_sm6375'
        required: true
        type: string
        default: 'lineage-22.2'
      android_version_name:
        description: 'Android version name (e.g., 13, 14)'
        required: true
        type: string
        default: '15'
      kernel_version_string:
        description: 'Kernel version string (e.g., 5.4, 5.10). Critical for SUSFS patch selection.'
        required: true
        type: string
        default: '5.4'

jobs:
  build_kernel_final_structure:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      MODEL_CODENAME: ${{ inputs.model }}
      KERNEL_SOURCE_REPO_URL: "https://github.com/Teamhackneyed/android_kernel_oneplus_sm6375.git"
      KERNEL_SOURCE_BRANCH: ${{ inputs.kernel_source_branch }}
      KERNEL_SOURCE_PARENT_DIR: "${{ github.workspace }}/${{ inputs.model }}" # e.g., /home/runner/work/.../larry
      KERNEL_DIR: "${{ github.workspace }}/${{ inputs.model }}/android_kernel_oneplus_sm6375" # Full path
      DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Setup System Environment and Dependencies
        run: |
          echo "DEBIAN_FRONTEND=noninteractive" >> $GITHUB_ENV
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/.ghcup /opt/hostedtoolcache/CodeQL /usr/local/share/powershell /usr/share/swift || true
          sudo docker image prune --all --force
          sudo apt-get update -qq
          sudo apt-get purge -y \
            aria2 ansible azure-cli shellcheck rpm xorriso zsync \
            esl-erlang firefox gfortran-8 gfortran-9 google-chrome-stable \
            google-cloud-sdk imagemagick \
            libmagickcore-dev libmagickwand-dev libmagic-dev ant ant-optional kubectl \
            mercurial apt-transport-https mono-complete libmysqlclient \
            unixodbc-dev yarn chrpath libssl-dev libxft-dev \
            libfreetype6 libfreetype6-dev libfontconfig1 libfontconfig1-dev \
            snmp pollinate libpq-dev postgresql-client powershell ruby-full \
            sphinxsearch subversion mongodb-org microsoft-edge-stable > /dev/null 2>&1 || true
          sudo apt-get purge -y $(dpkg-query -W -f='${binary:Package}\n' | grep -E '^mysql|^php|^dotnet') > /dev/null 2>&1 || true
          sudo apt-get autoremove -y > /dev/null 2>&1
          sudo apt-get autoclean -y > /dev/null 2>&1
          sudo apt-get install -y --no-install-recommends \
            git curl python3 python-is-python3 tree \
            build-essential bc libssl-dev libelf-dev \
            bison flex rsync libncurses-dev \
            zip unzip tar gzip bzip2 lzop patch > /dev/null 2>&1
          echo "System setup complete."

      - name: Install Repo Tool
        run: |
          mkdir -p ${{ github.workspace }}/git-repo-tool
          curl -sSL https://storage.googleapis.com/git-repo-downloads/repo > ${{ github.workspace }}/git-repo-tool/repo
          chmod a+rx ${{ github.workspace }}/git-repo-tool/repo
          echo "${{ github.workspace }}/git-repo-tool" >> $GITHUB_PATH

      - name: Set Common Environment Variables
        run: |
          echo "MODEL_CODENAME (from job env) is: ${{ env.MODEL_CODENAME }}"
          echo "KERNEL_DIR (from job env) is: ${{ env.KERNEL_DIR }}"

      - name: Clone External Dependencies (AnyKernel3, Patches, SUSFS sources)
        run: |
          echo "Cloning dependencies into $GITHUB_WORKSPACE..."
          ANYKERNEL_BRANCH="gki"
          SUSFS_BRANCH="kernel-${{ inputs.kernel_version_string }}" # e.g. kernel-5.10

          git clone https://github.com/TheWildJames/AnyKernel3.git -b "$ANYKERNEL_BRANCH" ${{ github.workspace }}/AnyKernel3
          git clone https://github.com/TheWildJames/kernel_patches.git ${{ github.workspace }}/kernel_patches
          
          echo "Attempting to clone simonpunk/susfs4ksu branch: $SUSFS_BRANCH"
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH" ${{ github.workspace }}/susfs4ksu || \
            (echo "Failed to clone $SUSFS_BRANCH from susfs4ksu, trying default branch (main/master)..." && \
             git clone https://gitlab.com/simonpunk/susfs4ksu.git ${{ github.workspace }}/susfs4ksu)
          
          if [ ! -d "${{ github.workspace }}/susfs4ksu" ]; then
            echo "ERROR: Failed to clone susfs4ksu repository. This is needed for SUSFS patches." >&2
            exit 1
          fi
          ls -alh ${{ github.workspace }}

      - name: Clone Kernel Source
        run: |
          echo "Creating kernel parent directory: ${{ env.KERNEL_SOURCE_PARENT_DIR }}"
          mkdir -p "${{ env.KERNEL_SOURCE_PARENT_DIR }}"
          cd "${{ env.KERNEL_SOURCE_PARENT_DIR }}"
          echo "Cloning kernel into $(basename ${{ env.KERNEL_DIR }})..."
          git clone "${{ env.KERNEL_SOURCE_REPO_URL }}" -b "${{ env.KERNEL_SOURCE_BRANCH }}" "$(basename ${{ env.KERNEL_DIR }})" --depth=1
          if [ ! -d "${{ env.KERNEL_DIR }}" ]; then echo "ERROR: Kernel directory ${{ env.KERNEL_DIR }} not found." >&2; exit 1; fi

      - name: List Initial Kernel Source Contents
        run: |
          cd "${{ env.KERNEL_DIR }}"
          echo "Contents of ${{ env.KERNEL_DIR }}:"; ls -alh
          if [ -f "./arch/arm64/configs/gki_defconfig" ]; then echo "Found: ./arch/arm64/configs/gki_defconfig"; else echo "NOT FOUND: ./arch/arm64/configs/gki_defconfig"; fi

      - name: Add KernelSU Next (using rifsxd/next-susfs)
        run: |
          cd "${{ env.KERNEL_DIR }}"
          echo "Adding KernelSU Next using rifsxd/KernelSU-Next/next-susfs setup..."
          curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next-susfs/kernel/setup.sh" | bash -s next-susfs

          echo "Running git submodule update --init --recursive after KSU setup..."
          ( test -d .git || git init -b temp_ksu_submodule_fix ) && git submodule update --init --recursive && (git rev-parse --abbrev-ref HEAD 2>/dev/null | grep -q temp_ksu_submodule_fix && git branch -D temp_ksu_submodule_fix || true)

          if [ -d "./KernelSU-Next/kernel" ]; then
            echo "KernelSU-Next/kernel directory found."
            (cd KernelSU-Next && echo "KSU-Next Described: $(git describe --tags --always)")
            if [ -f "./KernelSU-Next/kernel/Makefile" ] && grep -q "DKSU_VERSION=" "./KernelSU-Next/kernel/Makefile"; then
              KSUVER_FROM_MAKEFILE=$(grep "DKSU_VERSION=" "./KernelSU-Next/kernel/Makefile" | cut -d'=' -f2 | tr -d '[:space:]')
              if [[ "$KSUVER_FROM_MAKEFILE" =~ ^[0-9]+$ ]]; then
                echo "KSUVER extracted for zip naming: $KSUVER_FROM_MAKEFILE"
                echo "KSUVER=$KSUVER_FROM_MAKEFILE" >> $GITHUB_ENV
              fi
            else echo "Warning: DKSU_VERSION not found in KSU Makefile for KSUVER extraction."; fi
          else
            echo "ERROR: KernelSU-Next/kernel directory NOT found after rifsxd setup." >&2; exit 1;
          fi

      - name: Apply SUSFS Core Patches to Kernel Tree
        id: susfs_core_patch_step
        run: |
          cd "${{ env.KERNEL_DIR }}"
          PATCH_LOG_DIR="$GITHUB_WORKSPACE/patch_logs"; mkdir -p "$PATCH_LOG_DIR"
          SUSFS_SOURCE_DIR="$GITHUB_WORKSPACE/susfs4ksu"
          MAIN_SUSFS_PATCH_FILENAME="50_add_susfs_in_kernel-${{ inputs.kernel_version_string }}.patch" # Ensure this matches your kernel version string input
          MAIN_SUSFS_PATCH_PATH="$SUSFS_SOURCE_DIR/kernel_patches/$MAIN_SUSFS_PATCH_FILENAME"

          if [ ! -d "$SUSFS_SOURCE_DIR/kernel_patches" ]; then
            echo "ERROR: $SUSFS_SOURCE_DIR/kernel_patches not found. Cannot apply SUSFS core patches." >&2
            # exit 1 # Make this fatal if SUSFS is mandatory
            echo "::set-output name=patch_status::skipped_no_source_patches"
            exit 0 # Exiting non-fatally for now
          fi
          echo "Applying SUSFS core patches from $SUSFS_SOURCE_DIR to kernel root..."
          echo "Copying SUSFS fs/* files..."; if [ -d "$SUSFS_SOURCE_DIR/kernel_patches/fs" ]; then cp -rf "$SUSFS_SOURCE_DIR/kernel_patches/fs/"* ./fs/; else echo "Warning: fs dir not found in SUSFS source."; fi
          echo "Copying SUSFS include/linux/* files..."; if [ -d "$SUSFS_SOURCE_DIR/kernel_patches/include/linux" ]; then cp -rf "$SUSFS_SOURCE_DIR/kernel_patches/include/linux/"* ./include/linux/; else echo "Warning: include/linux dir not found in SUSFS source."; fi

          if [ -f "$MAIN_SUSFS_PATCH_PATH" ]; then
            echo "Applying main SUSFS patch: $MAIN_SUSFS_PATCH_FILENAME..."
            patch -p1 < "$MAIN_SUSFS_PATCH_PATH" > "$PATCH_LOG_DIR/susfs_core_patch.log" 2>&1
            PATCH_EXIT_CODE=$?
            if [ $PATCH_EXIT_CODE -eq 0 ]; then echo "Main SUSFS patch applied successfully."; echo "::set-output name=patch_status::success";
            else echo "ERROR: Main SUSFS patch FAILED (Code: $PATCH_EXIT_CODE). Check log." >&2; echo "::set-output name=patch_status::failed"; fi # Consider exit $PATCH_EXIT_CODE
          else echo "ERROR: Main SUSFS patch file not found: $MAIN_SUSFS_PATCH_PATH" >&2; echo "::set-output name=patch_status::skipped_no_patch_file"; fi # Consider exit 1
          
          echo "Verifying SUSFS integration post-patching..."
          if [ -f "./include/linux/susfs.h" ]; then echo "./include/linux/susfs.h FOUND."; else echo "CRITICAL ERROR: ./include/linux/susfs.h NOT FOUND." >&2; fi
          if grep -qE -R "INODE_STATE_SUS_KSTAT|SUS_KSTAT_BIT" ./include; then echo "SUSFS KSTAT definition seems present in kernel headers."; else echo "CRITICAL WARNING: SUSFS KSTAT definition NOT found. Build will likely fail."; fi

      - name: Apply KSUN Hooks Patch
        run: |
          cd "${{ env.KERNEL_DIR }}"
          PATCH_LOG_DIR="$GITHUB_WORKSPACE/patch_logs"; mkdir -p "$PATCH_LOG_DIR"
          echo "Applying KSUN Hooks..."
          if [ -f "$GITHUB_WORKSPACE/kernel_patches/next/syscall_hooks.patch" ]; then
            cp "$GITHUB_WORKSPACE/kernel_patches/next/syscall_hooks.patch" ./
            patch -p1 --fuzz=3 < ./syscall_hooks.patch > "$PATCH_LOG_DIR/ksun_hooks_patch.log" 2>&1 || echo "KSUN Hooks patch had issues, check log."
          else echo "KSUN Hooks patch not found, skipping."; fi

      - name: Apply Hide Stuff Patch
        run: |
          cd "${{ env.KERNEL_DIR }}"
          PATCH_LOG_DIR="$GITHUB_WORKSPACE/patch_logs"; mkdir -p "$PATCH_LOG_DIR"
          echo "Applying Hide Stuff Patches..."
          if [ -f "$GITHUB_WORKSPACE/kernel_patches/69_hide_stuff.patch" ]; then
            cp "$GITHUB_WORKSPACE/kernel_patches/69_hide_stuff.patch" .
            patch -p1 -F 3 < 69_hide_stuff.patch > "$PATCH_LOG_DIR/hide_stuff_patch.log" 2>&1 || echo "Hide Stuff patch had issues, check log."
          else echo "Hide Stuff patch not found, skipping."; fi

      - name: Add KernelSU and SUSFS Settings to Defconfig
        shell: bash
        run: |
          set -e; cd "${{ env.KERNEL_DIR }}"
          DEFCONFIG_PATH="./arch/arm64/configs/gki_defconfig"; echo "Adding KSU/SUSFS settings to $DEFCONFIG_PATH..."
          if [ ! -f "$DEFCONFIG_PATH" ]; then mkdir -p "$(dirname "$DEFCONFIG_PATH")" && touch "$DEFCONFIG_PATH"; fi
          add_cfg() { grep -qxF "$1" "$DEFCONFIG_PATH" || echo "$1" >> "$DEFCONFIG_PATH"; }
          add_cfg "CONFIG_KSU=y"; add_cfg "CONFIG_KSU_KPROBES_HOOK=n"; add_cfg "CONFIG_KSU_SUSFS=y"
          add_cfg "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y"; add_cfg "CONFIG_KSU_SUSFS_SUS_PATH=y"; add_cfg "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y"; add_cfg "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_SUS_KSTAT=y"; add_cfg "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n"; add_cfg "CONFIG_KSU_SUSFS_TRY_UMOUNT=y"
          add_cfg "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y"; add_cfg "CONFIG_KSU_SUSFS_SPOOF_UNAME=y"
          add_cfg "CONFIG_KSU_SUSFS_ENABLE_LOG=y"; add_cfg "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
          add_cfg "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y"; add_cfg "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y"
          add_cfg "CONFIG_KSU_SUSFS_SUS_SU=n"; add_cfg "CONFIG_TMPFS_XATTR=y"; add_cfg "CONFIG_TMPFS_POSIX_ACL=y"

      - name: Add BBR Support Settings to Defconfig
        shell: bash
        run: |
          set -e; cd "${{ env.KERNEL_DIR }}"
          DEFCONFIG_PATH="./arch/arm64/configs/gki_defconfig"; echo "Adding BBR settings to $DEFCONFIG_PATH..."
          if [ ! -f "$DEFCONFIG_PATH" ]; then echo "Warning: $DEFCONFIG_PATH not found for BBR." >&2; exit 0; fi
          add_cfg() { grep -qxF "$1" "$DEFCONFIG_PATH" || echo "$1" >> "$DEFCONFIG_PATH"; }
          set_cfg() { if grep -q "^$1=" "$DEFCONFIG_PATH"; then sed -i "s|^$1=.*|$1=$2|" "$DEFCONFIG_PATH"; else echo "$1=$2" >> "$DEFCONFIG_PATH"; fi; }
          add_cfg "CONFIG_TCP_CONG_ADVANCED=y"; add_cfg "CONFIG_TCP_CONG_BBR=y"; set_cfg "CONFIG_DEFAULT_TCP_CONG" "\"bbr\""
          set_cfg "CONFIG_TCP_CONG_BIC" "n"; set_cfg "CONFIG_TCP_CONG_WESTWOOD" "n"; set_cfg "CONFIG_TCP_CONG_HTCP" "n"
          add_cfg "CONFIG_NET_SCH_FQ=y"; add_cfg "CONFIG_NET_SCH_FQ_CODEL=y"

      - name: Add TTL Target Settings to Defconfig
        shell: bash
        run: |
          set -e; cd "${{ env.KERNEL_DIR }}"
          DEFCONFIG_PATH="./arch/arm64/configs/gki_defconfig"; echo "Adding TTL settings to $DEFCONFIG_PATH..."
          if [ ! -f "$DEFCONFIG_PATH" ]; then echo "Warning: $DEFCONFIG_PATH not found for TTL." >&2; exit 0; fi
          add_cfg() { grep -qxF "$1" "$DEFCONFIG_PATH" || echo "$1" >> "$DEFCONFIG_PATH"; }
          add_cfg "CONFIG_IP_NF_TARGET_TTL=y"; add_cfg "CONFIG_IP6_NF_TARGET_HL=y"; add_cfg "CONFIG_IP6_NF_MATCH_HL=y"

      - name: Apply LTO, Versioning, and Other Final Tweaks
        shell: bash
        run: |
          set -e; cd "${{ env.KERNEL_DIR }}"
          DEFCONFIG_PATH="./arch/arm64/configs/gki_defconfig"; echo "Applying LTO and versioning tweaks..."
          if [ -f "$DEFCONFIG_PATH" ]; then
            add_cfg_fn() { grep -qxF "$1" "$DEFCONFIG_PATH" || echo "$1" >> "$DEFCONFIG_PATH"; }
            if grep -q "CONFIG_LTO=n" "$DEFCONFIG_PATH"; then sed -i 's/CONFIG_LTO=n/CONFIG_LTO=y/' "$DEFCONFIG_PATH"; elif ! grep -q "CONFIG_LTO=y" "$DEFCONFIG_PATH"; then add_cfg_fn "CONFIG_LTO=y"; fi
            if grep -q "CONFIG_LTO=y" "$DEFCONFIG_PATH"; then 
              if grep -q "CONFIG_LTO_CLANG_FULL=y" "$DEFCONFIG_PATH"; then sed -i 's/CONFIG_LTO_CLANG_FULL=y/CONFIG_LTO_CLANG_THIN=y/' "$DEFCONFIG_PATH"; 
              elif grep -q "CONFIG_LTO_CLANG_NONE=y" "$DEFCONFIG_PATH"; then sed -i 's/CONFIG_LTO_CLANG_NONE=y/CONFIG_LTO_CLANG_THIN=y/' "$DEFCONFIG_PATH"; 
              elif ! grep -q "CONFIG_LTO_CLANG_THIN=y" "$DEFCONFIG_PATH"; then add_cfg_fn "CONFIG_LTO_CLANG_THIN=y"; fi
              if grep -q "CONFIG_LTO_CLANG_THIN=y" "$DEFCONFIG_PATH"; then sed -i '/CONFIG_LTO_CLANG_FULL=y/d' "$DEFCONFIG_PATH"; sed -i '/CONFIG_LTO_CLANG_NONE=y/d' "$DEFCONFIG_PATH"; fi
            fi
          else echo "Warning: $DEFCONFIG_PATH not found for LTO tweaks."; fi
          SETLOCALVERSION_PATHS=( "./scripts/setlocalversion" ); if [ -d "./msm-kernel/scripts" ]; then SETLOCALVERSION_PATHS+=( "./msm-kernel/scripts/setlocalversion" ); fi
          for sl_path in "${SETLOCALVERSION_PATHS[@]}"; do if [ -f "$sl_path" ]; then sed -i '$s|echo "\$res"|echo "\$res-Wild"|' "$sl_path"; sed -i 's/-dirty//' "$sl_path"; else echo "$sl_path not found."; fi; done
          DATESTR=$(date -u); MKCOMPILE_H_PATHS=( "./scripts/mkcompile_h" ); if [ -d "./msm-kernel/scripts" ]; then MKCOMPILE_H_PATHS+=( "./msm-kernel/scripts/mkcompile_h" ); fi
          for mc_path in "${MKCOMPILE_H_PATHS[@]}"; do if [ -f "$mc_path" ]; then perl -pi -e 's{UTS_VERSION="\$\(echo \$UTS_VERSION \$CONFIG_FLAGS \$TIMESTAMP \| cut -b -\$UTS_LEN\)"}{UTS_VERSION="#1 SMP PREEMPT '"$DATESTR"'"}' "$mc_path"; else echo "$mc_path not found."; fi; done

      - name: Setup Clang Toolchain
        run: |
          CLANG_REPO_URL="https://github.com/LineageOS/android_prebuilts_clang_kernel_linux-x86_clang-r416183b.git"
          CLANG_DIR="$GITHUB_WORKSPACE/clang-r416183b"
          if [ ! -d "$CLANG_DIR/bin" ]; then git clone "$CLANG_REPO_URL" "$CLANG_DIR" --depth=1; else echo "Clang r416183b found."; fi
          if [ ! -d "$CLANG_DIR/bin" ]; then echo "ERROR: Clang toolchain failed." >&2; exit 1; fi
          echo "$CLANG_DIR/bin" >> $GITHUB_PATH
          echo "LLVM=1" >> $GITHUB_ENV; echo "LLVM_IAS=1" >> $GITHUB_ENV; echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE=$CLANG_DIR/bin/aarch64-linux-gnu-" >> $GITHUB_ENV; echo "CROSS_COMPILE_ARM32=$CLANG_DIR/bin/arm-linux-gnueabi-" >> $GITHUB_ENV
          echo "Clang setup. Version:"; ${CLANG_DIR}/bin/clang --version

      - name: Build Kernel using Make
        env: { KBUILD_BUILD_USER: "${{ github.actor }}", KBUILD_BUILD_HOST: "GitHubActions" }
        run: |
          cd "${{ env.KERNEL_DIR }}"
          KERNEL_BUILD_OUT_DIR="$(pwd)/out"; mkdir -p "$KERNEL_BUILD_OUT_DIR"
          MAKE_ARGS="-j$(nproc) O=$KERNEL_BUILD_OUT_DIR ARCH=arm64"
          if [ "$LLVM" == "1" ]; then MAKE_ARGS="$MAKE_ARGS LLVM=1 LLVM_IAS=1 CLANG_TRIPLE=$CLANG_TRIPLE CROSS_COMPILE=$CROSS_COMPILE CROSS_COMPILE_ARM32=$CROSS_COMPILE_ARM32"; fi
          echo "Applying defconfig: arch/arm64/configs/gki_defconfig"; make $MAKE_ARGS gki_defconfig
          echo "Building Image & dtbs"; make $MAKE_ARGS Image dtbs
          ARTIFACT_STAGING_DIR="$(dirname "$KERNEL_BUILD_OUT_DIR")/out_dist"; mkdir -p "$ARTIFACT_STAGING_DIR"
          KERNEL_IMAGE_SRC="$KERNEL_BUILD_OUT_DIR/arch/arm64/boot/Image"
          if [ -f "$KERNEL_IMAGE_SRC" ]; then cp "$KERNEL_IMAGE_SRC" "$ARTIFACT_STAGING_DIR/Image"; else KERNEL_IMAGE_GZ_SRC="$KERNEL_BUILD_OUT_DIR/arch/arm64/boot/Image.gz"; if [ -f "$KERNEL_IMAGE_GZ_SRC" ]; then gunzip -c "$KERNEL_IMAGE_GZ_SRC" > "$ARTIFACT_STAGING_DIR/Image"; else echo "ERROR: Kernel Image not found!" >&2; exit 1; fi; fi
          echo "Image staged. Staging dtbo.img..."
          MKDTIMG_PATH="/usr/bin/mkdtimg"; OUTPUT_DTS_DIR="$KERNEL_BUILD_OUT_DIR/arch/arm64/boot/dts"
          if ! command -v mkdtimg &> /dev/null; then if [ -f "$GITHUB_WORKSPACE/tools/mkdtimg" ]; then MKDTIMG_PATH="$GITHUB_WORKSPACE/tools/mkdtimg"; chmod +x "$MKDTIMG_PATH"; else MKDTIMG_PATH=""; fi; fi
          DTBO_FILES_FOUND=$(find "$OUTPUT_DTS_DIR" -type f -name "*.dtbo" -print) 
          if [ -n "$MKDTIMG_PATH" ] && [ -n "$DTBO_FILES_FOUND" ]; then DTBO_ARGS=$(echo "$DTBO_FILES_FOUND" | tr '\n' ' '); if [ -n "$DTBO_ARGS" ]; then "$MKDTIMG_PATH" create "$ARTIFACT_STAGING_DIR/dtbo.img" $DTBO_ARGS; if [ -f "$ARTIFACT_STAGING_DIR/dtbo.img" ]; then echo "dtbo.img created."; else echo "ERROR: mkdtimg failed."; fi; else echo "No .dtbo for mkdtimg."; fi; elif [ -n "$DTBO_FILES_FOUND" ]; then echo "mkdtimg missing."; else echo "No .dtbo files for dtbo.img creation."; fi
          if [ ! -f "$ARTIFACT_STAGING_DIR/dtbo.img" ]; then for pth in "$KERNEL_BUILD_OUT_DIR/arch/arm64/boot/dtbo.img" "$KERNEL_BUILD_OUT_DIR/dtbo.img"; do if [ -f "$pth" ]; then cp "$pth" "$ARTIFACT_STAGING_DIR/dtbo.img"; echo "Used pre-existing dtbo.img from $pth"; break; fi; done; fi
          if [ ! -f "$ARTIFACT_STAGING_DIR/dtbo.img" ]; then echo "FINAL WARNING: dtbo.img not staged."; fi

      - name: Copy Staged Images to AnyKernel3
        run: |
          ARTIFACT_SOURCE_DIR="$GITHUB_WORKSPACE/${{ env.MODEL_CODENAME }}/out_dist"
          ANYKERNEL_DIR="$GITHUB_WORKSPACE/AnyKernel3"
          if [ ! -d "$ARTIFACT_SOURCE_DIR" ] || [ ! -f "$ARTIFACT_SOURCE_DIR/Image" ]; then echo "ERROR: Staged artifacts missing." >&2; exit 1; fi
          cp "$ARTIFACT_SOURCE_DIR/Image" "$ANYKERNEL_DIR/Image"
          if [ "${{ env.MODEL_CODENAME }}" == "larry" ]; then if [ -f "$ARTIFACT_SOURCE_DIR/dtbo.img" ]; then cp "$ARTIFACT_SOURCE_DIR/dtbo.img" "$ANYKERNEL_DIR/dtbo.img"; else echo "No dtbo.img for larry."; fi; fi

      - name: Create AnyKernel3 ZIP Package
        run: |
          ANYKERNEL_DIR="$GITHUB_WORKSPACE/AnyKernel3"; cd "$ANYKERNEL_DIR"
          KSU_VERSION_FOR_ZIP="${{ env.KSUVER || 'DevBuild' }}" 
          ZIP_NAME="${{ env.MODEL_CODENAME }}_A${{ inputs.android_version_name }}_K${{ inputs.kernel_version_string }}_KSUNext_${KSU_VERSION_FOR_ZIP}_SUSFS_AnyKernel3.zip"
          echo "Creating zip: ../$ZIP_NAME"; zip -r9 "../$ZIP_NAME" ./* -x ".git/*" -x ".github/*" -x "__MACOSX"
          if [ "${{ env.MODEL_CODENAME }}" == "OPAce5Pro" ]; then if [ -f "./dtbo.img" ]; then mkdir -p ../cn_zip_temp && cp -r ./* ../cn_zip_temp/ && sed -i 's/hmbird/xxbird/g' ../cn_zip_temp/dtbo.img && (cd ../cn_zip_temp && zip -r9 "../../${ZIP_NAME%.zip}-CN-version.zip" ./* -x ".git/*" -x ".github/*" -x "__MACOSX") && rm -rf ../cn_zip_temp; else echo "No dtbo for OPAce5Pro CN zip."; fi; fi
          cd "$GITHUB_WORKSPACE"; ls -alh *.zip

      - name: Upload Build Artifacts (Patch Logs and Kernel ZIPs)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-artifacts-${{ env.MODEL_CODENAME }}
          path: |
            ${{ github.workspace }}/*.zip
            ${{ github.workspace }}/patch_logs/
          if-no-files-found: ignore 
